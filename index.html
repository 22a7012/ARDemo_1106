<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>AR.js 固定モデルサンプル</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.min.js"></script>
</head>
<body style="margin:0; overflow:hidden;">

  <a-scene embedded arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;">
    
    <!-- カメラ -->
    <a-entity camera></a-entity>

    <!-- マーカー -->
    <a-marker type="pattern" url="https://raw.githubusercontent.com/AR-js-org/AR.js/master/three.js/data/patt.hiro" id="hiroMarker">
      <a-entity id="model" gltf-model="#chaei" scale="0.5 0.5 0.5" visible="false"></a-entity>
    </a-marker>

    <!-- モデルをプリロード -->
    <a-assets>
      <a-asset-item id="chaei" src="chaei.glb"></a-asset-item>
    </a-assets>

    <!-- マーカー検出後の固定処理 -->
    <script>
      let modelEl = null;
      let fixed = false;
      let savedPosition = new THREE.Vector3();
      let savedRotation = new THREE.Quaternion();

      document.addEventListener('DOMContentLoaded', () => {
        modelEl = document.getElementById('model');
        const marker = document.getElementById('hiroMarker');

        // マーカーが見えたとき
        marker.addEventListener('markerFound', () => {
          if (!fixed) {
            modelEl.setAttribute('visible', true);

            // 現在の世界座標・回転を保存
            const threeObj = modelEl.object3D;
            savedPosition.copy(threeObj.getWorldPosition(new THREE.Vector3()));
            savedRotation.copy(threeObj.getWorldQuaternion(new THREE.Quaternion()));
            fixed = true;
          }
        });

        // 毎フレーム、固定位置に維持
        modelEl.sceneEl.addEventListener('renderstart', () => {
          modelEl.sceneEl.renderer.setAnimationLoop(() => {
            if (fixed) {
              modelEl.object3D.position.copy(savedPosition);
              modelEl.object3D.quaternion.copy(savedRotation);
            }
          });
        });
      });
    </script>

  </a-scene>
</body>
</html>

